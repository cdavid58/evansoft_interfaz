{% load static %}
<!DOCTYPE html>
<html>
<head>
	<!-- Basic Page Info -->
	<meta charset="utf-8">
	<title>Evansoft App</title>
	<link rel="apple-touch-icon" sizes="180x180" href="{% static 'vendors/images/apple-touch-icon.png' %}">
	<link rel="icon" type="image/png" sizes="32x32" href="{% static 'vendors/images/favicon-32x32.png' %}">
	<link rel="icon" type="image/png" sizes="16x16" href="{% static 'vendors/images/favicon-16x16.png' %}">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="{% static 'vendors/styles/core.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'vendors/styles/icon-font.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'src/plugins/datatables/css/dataTables.bootstrap4.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'src/plugins/datatables/css/responsive.bootstrap4.min.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'src/plugins/dropzone/src/dropzone.css' %}">
	<link rel="stylesheet" type="text/css" href="{% static 'vendors/styles/style.css' %}">

	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-119386393-1"></script>
	<link rel="manifest" href="{% static 'manifest.json' %}">
	<link rel="stylesheet" href="{% static 'evangeli/evangeli.css' %}">
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', 'UA-119386393-1');
	</script>
	<style>
		input[type=number]::-webkit-inner-spin-button, 
		input[type=number]::-webkit-outer-spin-button { 
		  -webkit-appearance: none; 
		  margin: 0; 
		}
		input[type=number] { -moz-appearance:textfield; }

		/* Spinner centrado */
		.spinner {
			width: 80px;
			height: 80px;
			border: 8px solid rgba(0, 0, 0, 0.1); /* Bordes suaves */
			border-top-color: #3498db; /* Color principal del borde superior */
			border-radius: 50%; /* Hace que el div sea circular */
			animation: spin 1s linear infinite; /* Animaci√≥n de giro infinita */
			overflow: hidden;
		}

		/* Animaci√≥n de giro */
		@keyframes spin {
			0% {
			  transform: rotate(0deg);
			}
			100% {
			  transform: rotate(360deg);
			}
		}

		/* Estilos adicionales */
		.modal-body p {
			font-size: 18px;
			color: #333;
			overflow: hidden;
		}

		.notification-badge {
		    position: absolute;
		    top: -5px;
		    right: -5px;
		    background-color: red;
		    color: white;
		    font-size: 12px;
		    font-weight: bold;
		    padding: 3px 7px;
		    border-radius: 50%;
		    display: inline-block;
		    min-width: 20px;
		    text-align: center;
		    line-height: 1;
		    cursor: pointer;
		}

	</style>
	<!-- 32244 -->
</head>
<body>

	<div class="header">
		<div class="header-left">
			<div class="menu-icon dw dw-menu"></div>
			<div class="search-toggle-icon dw dw-search2" data-toggle="header_search"></div>
			<div class="header-search">
				<!-- <form>
					<div class="form-group mb-0">
						<i class="dw dw-search2 search-icon"></i>
						<input type="text" class="form-control search-input" placeholder="Search Here">
						<div class="dropdown">
							<a class="dropdown-toggle no-arrow" href="#" role="button" data-toggle="dropdown">
								<i class="ion-arrow-down-c"></i>
							</a>
							<div class="dropdown-menu dropdown-menu-right">
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">From</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">To</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">Subject</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="text-right">
									<button class="btn btn-primary">Search</button>
								</div>
							</div>
						</div>
					</div>
				</form> -->
			</div>
		</div>
		<div class="header-right">
			<div class="user-notification">
				<div class="dropdown">
					<a class="dropdown-toggle no-arrow" href="javascript:void(0);" role="button" id="notification-toggle" style="position: relative;">
					    <i class="icon-copy dw dw-notification"></i>
					    <span class="notification-badge" id="notification-badge">0</span>
					</a>

					<div class="dropdown-menu dropdown-menu-right" id="notification-dropdown">
					    <div class="notification-list mx-h-350 customscroll">
					        <ul id="notification-list"></ul>
					    </div>
					</div>
				</div>
			</div>
			<div class="user-info-dropdown">
				<div class="dropdown">
					<a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown">
						<span class="user-icon">
							<img src="{{request.session.logo}}" style="width: 100% !important; height: 100% !important;" alt="">
						</span>
						<span class="user-name">{{request.session.name_employee}}</span>
					</a>
					<div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
						{% if not request.session.create_box %}
							<a class="dropdown-item" href="{% url 'OutLogin' %}"><i class="dw dw-logout"></i>Salir</a>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>


	<div class="left-side-bar">
		<div class="brand-logo">
			<a href="{% url 'Index' %}">
				<img src="{% static 'vendors/images/deskapp-logo.svg' %}" alt="" class="dark-logo">
				<img src="{% static 'vendors/images/deskapp-logo-white.svg' %}" alt="" class="light-logo">
			</a>
			<div class="close-sidebar" data-toggle="left-sidebar-close">
				<i class="ion-close-round"></i>
			</div>
		</div>
		<div class="menu-block customscroll">
			<div class="sidebar-menu">
				<ul id="accordion-menu">

					<!-- HOME -->
					<li>
						<a href="{% url 'Index' %}" class="dropdown-toggle no-arrow">
							<span class="micon dw dw-house-1"></span><span class="mtext">Inicio</span>
						</a>
					</li>

					<!-- SECCI√ìN: FACTURACI√ìN -->
					{% if request.session.rols in 'Todos,Facturador' %}
						<li class="dropdown">
							<a href="javascript:void(0);" class="dropdown-toggle">
								<span class="micon dw dw-apartment"></span><span class="mtext">Ventas</span>
							</a>
							<ul class="submenu">
								<li><a href="{% url 'Create_Invoice' 1 %}">Crear factura</a></li>
								<li><a href="{% url 'Crete_Quote' 27 %}">Crear cotizaci√≥n</a></li>
								<li><a href="{% url 'Create_Transfer' 28 %}">Crear Traslado</a></li>
								<!-- <li><a href="{% url 'Create_Novelty' %}">Registrar novedad</a></li> -->
								<!-- <li><a href="javascript:void(0);" onclick="alert('Pr√≥ximamente');">Nomina</a></li>
								<li><a href="javascript:void(0);" onclick="alert('Pr√≥ximamente');">Documento soporte</a></li> -->
							</ul>
						</li>

						<li class="dropdown">
							<a href="javascript:void(0);" class="dropdown-toggle">
								<span class="micon dw dw-invoice"></span><span class="mtext">Documentos generados</span>
							</a>
							<ul class="submenu">
								<li><a href="{% url 'List_Invoice' 1 %}">Facturas</a></li>
								<li><a href="{% url 'List_Invoice' 99 %}">Remisiones</a></li>
								<li><a href="{% url 'List_Invoice' 4 %}">Notas cr√©dito</a></li>
								<li><a href="{% url 'List_Invoice' 27 %}">Cotizaciones</a></li>
								<!-- <li><a href="{% url 'List_Invoice' 28 %}">Traslado</a></li> -->
								<li class="dropdown">
									<a href="javascript:;" class="dropdown-toggle">
										<span class="micon fa fa-file-text"></span><span class="mtext">Traslados</span>
									</a>
									<ul class="submenu child">
										<li><a href="{% url 'List_Invoice' 28 %}" class="">Entradas</a></li>
										<li><a href="{% url 'List_Invoice' 281 %}" class="">Salidas</a></li>
									</ul>
								</li>
							</ul>
						</li>

						<li>
							<a href="{% url 'List_Customer' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-user1"></span><span class="mtext">Clientes</span>
							</a>
						</li>

						{% if request.session.create_box %}
							<li>
								<a href="javascript:void(0);" class="dropdown-toggle no-arrow close_box">
									<span class="micon dw dw-invoice"></span><span class="mtext">Cierre de caja</span>
								</a>
							</li>
						{% endif %}
					{% endif %}

					<!-- SECCI√ìN: ADMINISTRATIVA -->
					{% if request.session.rols in 'Todos,Administativo' %}
						<li>
							<a href="{% url 'List_Inventory' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-shop"></span><span class="mtext">Inventario</span>
							</a>
						</li>

						<li>
							<a href="{% url 'List_Supplier' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-user1"></span><span class="mtext">Proveedores</span>
							</a>
						</li>

						<li>
							<a href="{% url 'Create_Shopping' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-shopping-bag"></span><span class="mtext">Registrar compra</span>
							</a>
						</li>

						<li>
							<a href="{% url 'List_Shopping' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-list3"></span><span class="mtext">Listado de compras</span>
							</a>
						</li>

						<li>
							<a href="{% url 'List_Employee' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-user1"></span><span class="mtext">Empleados</span>
							</a>
						</li>

						<li>
							<a href="{% url 'Get_All_accounts_Receivable_View' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-wallet-1"></span><span class="mtext">Cartera</span>
							</a>
						</li>

						<li>
							<a href="{% url 'List_Customer' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-cursor-2"></span><span class="mtext">Correo electr√≥nico</span>
							</a>
						</li>

						<li>
							<a href="{% url 'Evangeli' %}" class="dropdown-toggle no-arrow">
								<span class="micon dw dw-worldwide"></span><span class="mtext">Evangeli</span>
							</a>
						</li>
					{% endif %}

					<!-- SECCI√ìN: REPORTES -->
					{% if request.session.rols in 'Todos,Administativo,Contador' %}
						<li class="dropdown">
							<a href="javascript:void(0);" class="dropdown-toggle">
								<span class="micon dw dw-invoice"></span><span class="mtext">Reportes</span>
							</a>
							<ul class="submenu">

								<!-- Reportes de facturaci√≥n -->
								<li class="dropdown">
									<a href="javascript:;" class="dropdown-toggle">
										<span class="micon fa fa-file-text"></span><span class="mtext">Facturaci√≥n</span>
									</a>
									<ul class="submenu child">
										<li><a href="javascript:void(0);" class="export_sales_report">Exportar ventas por IVA</a></li>
										<li><a href="javascript:void(0);" class="generate_closure_report_by_date">Reporte de ventas</a></li>
										<li><a href="javascript:void(0);" class="export_invoices_to_excel">Resumen de ventas</a></li>
									</ul>
								</li>

								<!-- Reportes contables -->
								<li class="dropdown">
									<a href="javascript:;" class="dropdown-toggle">
										<span class="micon fa fa-calculator"></span><span class="mtext">Contabilidad</span>
									</a>
									<ul class="submenu child">
										<li><a href="javascript:void(0);" class="generate_journal_report">Asientos contables</a></li>
									</ul>
								</li>

								<!-- Reportes de inventario -->
								{% if request.session.rols in 'Todos,Administativo' %}
									<li class="dropdown">
										<a href="javascript:;" class="dropdown-toggle">
											<span class="micon fa fa-shopping-bag"></span><span class="mtext">Inventario</span>
										</a>
										<ul class="submenu child">
											<li><a href="javascript:void(0);" class="Get_Profit_Report_Excel">Informe de ganancias</a></li>
											<li><a href="{% url 'View_Sales_Product' %}">M√°s vendidos</a></li>
											<li><a class="history_mov" href="javascript:void(0);">Historial de movimientos</a></li>
											<li><a href="javascript:void(0);" class="sales_by_product">Ventas por producto</a></li>
										</ul>
									</li>
								{% endif %}
							</ul>
						</li>
					{% endif %}

					<!-- SECCI√ìN: CONFIGURACI√ìN -->
					{% if request.session.rols == 'Todos' %}
						<li>
							<div class="dropdown-divider"></div>
						</li>
						<li class="dropdown">
							<a href="javascript:void(0);" class="dropdown-toggle">
								<span class="micon dw dw-settings2"></span><span class="mtext">Configuraci√≥n</span>
							</a>
							<ul class="submenu">
								<li><a href="{% url 'Setting_Company' %}">Compa√±√≠a</a></li>
								<li><a href="{% url 'List_Branch' %}">Sucursales</a></li>
							</ul>
						</li>
					{% endif %}
				</ul>
				<div class="d-none d-md-block" style="height: 50px;"></div>
			</div>
		</div>
	</div>
	<div class="mobile-menu-overlay"></div>

	<div class="main-container">
		<div class="pd-ltr-20 xs-pd-20-10">
			<div class="min-height-200px">
				<div class="page-header">
					{% block content %}
					{% endblock %}
				</div>
			</div>
			<div class="footer-wrap pd-20 mb-20 card-box">
				DeskApp - Developed By Evansoft</a>
			</div>
		</div>
	</div>



	<!-- START MODALS -->

		<a href="javascript:void(0);" class="btn-block export_sales_report_modal" hidden data-toggle="modal" data-target="#Export_Sales_Report" type="button">Modal</a>
		<div class="modal fade" id="Export_Sales_Report" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" id="myLargeModalLabel">Seleccione fecha inicial y final</h4>
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">√ó</button>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="fecha-inicial" class="form-label">Fecha Inicial</label>
							<div class="input-group custom">
								<input type="date" id="fecha-inicial" class="form-control form-control-lg" placeholder="Selecciona una fecha">
								<div class="input-group-append custom">
									<span class="input-group-text">
										<i class="icon-copy dw dw-calendar"></i>
									</span>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="fecha-final" class="form-label">Fecha Final</label>
							<div class="input-group custom">
								<input type="date" id="fecha-final" class="form-control form-control-lg" placeholder="Selecciona una fecha">
								<div class="input-group-append custom">
									<span class="input-group-text">
										<i class="icon-copy dw dw-calendar"></i>
									</span>
								</div>
							</div>
						</div>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary close_export_data" data-dismiss="modal">Cerrar</button>
						<button type="button" class="btn btn-primary export_data">Generar Reporte</button>
					</div>
				</div>
			</div>
		</div>



		<a href="javascript:void(0);" class="btn-block generate_journal_report_modal" hidden data-toggle="modal" data-target="#Generate_Journal_Report" type="button">Modal</a>
		<div class="modal fade" id="Generate_Journal_Report" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" id="myLargeModalLabel">Seleccione fecha inicial y final</h4>
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">√ó</button>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="fecha-inicial_journal" class="form-label">Fecha Inicial</label>
							<div class="input-group custom">
								<input type="date" id="fecha-inicial_journal" class="form-control form-control-lg" placeholder="Selecciona una fecha">
								<div class="input-group-append custom">
									<span class="input-group-text">
										<i class="icon-copy dw dw-calendar"></i>
									</span>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="fecha-final_journal" class="form-label">Fecha Final</label>
							<div class="input-group custom">
								<input type="date" id="fecha-final_journal" class="form-control form-control-lg" placeholder="Selecciona una fecha">
								<div class="input-group-append custom">
									<span class="input-group-text">
										<i class="icon-copy dw dw-calendar"></i>
									</span>
								</div>
							</div>
						</div>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary close_generate_journal_report_data" data-dismiss="modal">Cerrar</button>
						<button type="button" class="btn btn-primary generate_journal_report_data">Generar Reporte</button>
					</div>
				</div>
			</div>
		</div>

		<a href="javascript:void(0);" class="btn-block get_profit_report_excel_modal" hidden data-toggle="modal" data-target="#Get_Profit_Report_Excel" type="button">Modal</a>
		<div class="modal fade" id="Get_Profit_Report_Excel" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title" id="myLargeModalLabel">Seleccione fecha inicial y final</h4>
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">√ó</button>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="fecha-inicial_Get_Profit_Report_Excel" class="form-label">Fecha Inicial</label>
							<div class="input-group custom">
								<input type="date" id="fecha-inicial_Get_Profit_Report_Excel" class="form-control form-control-lg" placeholder="Selecciona una fecha">
								<div class="input-group-append custom">
									<span class="input-group-text">
										<i class="icon-copy dw dw-calendar"></i>
									</span>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="fecha-final_Get_Profit_Report_Excel" class="form-label">Fecha Final</label>
							<div class="input-group custom">
								<input type="date" id="fecha-final_Get_Profit_Report_Excel" class="form-control form-control-lg" placeholder="Selecciona una fecha">
								<div class="input-group-append custom">
									<span class="input-group-text">
										<i class="icon-copy dw dw-calendar"></i>
									</span>
								</div>
							</div>
						</div>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary close_Get_Profit_Report_Excel_data" data-dismiss="modal">Cerrar</button>
						<button type="button" class="btn btn-primary Get_Profit_Report_Excel_data">Generar Reporte</button>
					</div>
				</div>
			</div>
		</div>



		<div class="modal fade loader1" id="loader1" data-bs-keyboard="false" data-bs-backdrop="static" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		  <div class="modal-dialog modal-lg mt-6 modal-dialog-centered" role="document">
		    <div class="modal-content border-0">
		      <div class="modal-body p-0 d-flex flex-column justify-content-center align-items-center" style="min-height: 300px;">
		        <div class="spinner"></div>
		        <p class="mt-3 text-dark text_send_email"></p>
		      </div>
		    </div>
		  </div>
		</div>

		<div class="modal fade" id="modalHistoryMovement" tabindex="-1" role="dialog" aria-labelledby="modalResolutionLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title" id="modalResolutionLabel" style="color: white;">Historial de Movimiento de Inventario</h5>
						<button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<form id="form_resolution">
							<div class="form-group">
								<label for="selectBranch">Sucursal</label>
								<select class="form-control" id="selectBranch" name="branch_id">
									<option value="">Seleccione una sucursal</option>
									{% for i in request.session.list_branch %}
										<option value="{{ i.id }}">{{ i.business_name }}</option>
									{% endfor %}
								</select>
							</div>

							<div class="form-group">
								<label for="start_date">Fecha de inicio</label>
								<input type="date" class="form-control" id="start_date" name="start_date">
							</div>

							<div class="form-group">
								<label for="end_date">Fecha de fin</label>
								<input type="date" class="form-control" id="end_date" name="end_date">
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
						<button type="button" class="btn btn-primary" id="historymovement">Descargar</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="generate_closure_report_by_date" tabindex="-1" role="dialog" aria-labelledby="modalResolutionLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title" id="modalResolutionLabel" style="color: white;">Cierre de Caja por fecha</h5>
						<button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<form id="form_resolution">
							<div class="form-group">
								<label for="selectBranchs">Sucursal</label>
								<select class="form-control" id="selectBranchs" name="branch_id">
									<option value="">Seleccione una sucursal</option>
									{% for i in request.session.list_branch %}
										<option value="{{ i.id }}">{{ i.business_name }}</option>
									{% endfor %}
								</select>
							</div>

							<div class="form-group">
								<label for="selectEmployee">Empleado</label>
								<select class="form-control" id="selectEmployee" name="employee_id">
									<option value="">Seleccione un empleado</option>
									{% for i in request.session.list_employee %}
										<option value="{{ i.id }}">{{ i.first_name|title }} {{ i.surname|title }}</option>
									{% endfor %}
								</select>
							</div>

							<div class="form-group">
								<label for="start_date">Fecha de inicio</label>
								<input type="date" class="form-control" id="start_dates" name="start_date">
							</div>

							<div class="form-group">
								<label for="end_date">Fecha de fin</label>
								<input type="date" class="form-control" id="end_dates" name="end_date">
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
						<button type="button" class="btn btn-primary" id="Generate_Closure_Report_By_Date">Consultar</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="sales_by_product_modal" tabindex="-1" role="dialog" aria-labelledby="modalResolutionLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title" id="modalResolutionLabel" style="color: white;">Ventas por productos</h5>
						<button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<form id="form_resolution">
							<div class="form-group">
								<label for="selectBranchs">Sucursal</label>
								<select class="form-control" id="selectBranchs_sales_by_product" name="branch_id">
									<option value="">Seleccione una sucursal</option>
									{% for i in request.session.list_branch %}
										<option value="{{ i.id }}">{{ i.business_name }}</option>
									{% endfor %}
								</select>
							</div>

							<div class="form-group">
								<label for="start_date">Fecha Inicial</label>
								<input type="date" class="form-control" id="start_dates_sales_by_product" name="start_dates_sales_by_product">
							</div>

							<div class="form-group">
								<label for="start_date">Fecha Final</label>
								<input type="date" class="form-control" id="end_dates_sales_by_product" name="end_dates_sales_by_product">
							</div>

						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
						<button type="button" class="btn btn-primary" id="Generate_Closure_Sales_By_Product">Consultar</button>
					</div>
				</div>
			</div>
		</div>

		<div class="modal fade" id="modal_export_invoices_to_excel" tabindex="-1" role="dialog" aria-labelledby="modal_export_invoices_to_excel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header bg-primary text-white">
						<h5 class="modal-title" id="modal_export_invoices_to_excel" style="color: white;">Resumen de venta</h5>
						<button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<form id="form_export_invoices_to_excel">
							<div class="form-group">
								<label for="start_date">Fecha Inicial</label>
								<input type="date" class="form-control" id="start_date__export_invoices_to_excel_from" name="start_date__export_invoices_to_excel">
							</div>
							<div class="form-group">
								<label for="start_date">Fecha Final</label>
								<input type="date" class="form-control" id="end_date__export_invoices_to_excel_to" name="end_date__export_invoices_to_excel">
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
						<button type="button" class="btn btn-primary" id="export_invoices_to_excel">Descargar</button>
					</div>
				</div>
			</div>
		</div>


		<!-- Modal Preloader -->
		<div class="modal fade" id="preloaderModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
		  <div class="modal-dialog modal-dialog-centered" role="document">
		    <div class="modal-content text-center">
		      <div class="modal-body">
		        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
		          <span class="sr-only">Cargando...</span>
		        </div>
		        <h5 class="mb-0 message_modal"></h5>
		        <p class="text-muted mb-0">Por favor espera un momento</p>
		      </div>
		    </div>
		  </div>
		</div>




	<!-- END MODALS -->

	<script src="{% static 'vendors/scripts/core.js' %}"></script>
	<script src="{% static 'vendors/scripts/script.min.js' %}"></script>
	<script src="{% static 'vendors/scripts/process.js' %}"></script>
	<script src="{% static 'vendors/scripts/layout-settings.js' %}"></script>
	<script src="{% static 'src/plugins/apexcharts/apexcharts.min.js' %}"></script>
	<script src="{% static 'src/plugins/cropperjs/dist/cropper.js' %}"></script>
	<script src="{% static 'evangeli/information.js' %}"></script>
	<script>

		window.addEventListener('DOMContentLoaded', function () {
			var image = document.getElementById('image');
			var cropBoxData;
			var canvasData;
			var cropper;

			$('#modal').on('shown.bs.modal', function () {
				cropper = new Cropper(image, {
					autoCropArea: 0.5,
					dragMode: 'move',
					aspectRatio: 3 / 3,
					restore: false,
					guides: false,
					center: false,
					highlight: false,
					cropBoxMovable: false,
					cropBoxResizable: false,
					toggleDragModeOnDblclick: false,
					ready: function () {
						cropper.setCropBoxData(cropBoxData).setCanvasData(canvasData);
					}
				});
			}).on('hidden.bs.modal', function () {
				cropBoxData = cropper.getCropBoxData();
				canvasData = cropper.getCanvasData();
				cropper.destroy();
			});
		});
	</script>
	<script src="{% static 'src/plugins/dropzone/src/dropzone.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/jquery.dataTables.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/dataTables.bootstrap4.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/dataTables.responsive.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/responsive.bootstrap4.min.js' %}"></script>

	<!-- buttons for Export datatable -->
	<script src="{% static 'src/plugins/datatables/js/dataTables.buttons.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/buttons.bootstrap4.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/buttons.print.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/buttons.html5.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/buttons.flash.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/pdfmake.min.js' %}"></script>
	<script src="{% static 'src/plugins/datatables/js/vfs_fonts.js' %}"></script>
	<script src="{% static 'vendors/scripts/datatable-setting.js' %}"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script>
		const numberWords = {
		    "un": 1,
		    "uno": 1,
		    "dos": 2,
		    "tres": 3,
		    "cuatro": 4,
		    "cinco": 5,
		    "seis": 6,
		    "siete": 7,
		    "ocho": 8,
		    "nueve": 9,
		    "diez": 10,
		    "once": 11,
		    "doce": 12,
		    "trece": 13,
		    "catorce": 14,
		    "quince": 15,
		    "diecis√©is": 16,
		    "diecisiete": 17,
		    "dieciocho": 18,
		    "diecinueve": 19,
		    "veinte": 20
		};
	</script>

	<!-- START VARIABLES GLOBALES -->
		<script>
			let evangeli = "Evangeli"
			let calling = false
			let company_id = {{request.session.company_id|safe}}
			let get_customer_url = "{% url 'Get_Customer' %}"
			let list_customer_data = []
			let disableRefresh = false;
			let url_product = '{% url "Get_Product_By_Name" %}'
			let url_all_inventory = "{% url 'Get_All_Inventory' %}"
		</script>
	<!-- END VARIABLES GLOBALES -->


	<script>

		url_static_files = "{% url 'service_worker_cache' %}"
		function Notification(icon, title, text, confirmButtonText){
			Swal.fire({
	            icon:icon,
	            title:title,
	            text:text,
	            confirmButtonText:confirmButtonText
	        });
		}

		function showPreloaderModal() {
		  $('#preloaderModal').modal('show');
		}
		
		function hidePreloaderModal() {
		  $('#preloaderModal').modal('hide');
		}

		$(document).ready(function(){

			let maintenance;
			let reconnectInterval = null;

			function connectMaintenance() {
			    maintenance = new WebSocket("{{request.session.url_websokect}}");
			    // let maintenance = new WebSocket("wss://127.0.0.1:8000/ws/resolution/");

			    maintenance.onopen = function () {
			        console.log("‚úÖ Conexi√≥n WebSocket de mantenimiento establecida");
			        clearInterval(reconnectInterval); // detener reconexiones

			        controlarMantenimiento(); // arranca el ciclo de mantenimiento
			    };

			    maintenance.onmessage = function (event) {
			        try {
			            let data = JSON.parse(event.data);
			            if (data.result) {
			                Notification(
			                    data.icon,
			                    data.title,
			                    data.message,
			                    data.button
			                );
			            }
			        } catch (error) {
			            console.error("Error al procesar mensaje WebSocket:", error);
			        }
			    };

			    maintenance.onerror = function (error) {
			        console.warn("‚ö†Ô∏è Error en WebSocket de mantenimiento:", error);
			    };

			    maintenance.onclose = function () {
			        console.log("‚ùå Conexi√≥n WebSocket cerrada.");

			        // Solo intenta reconectar si tienes internet
			        if (navigator.onLine) {
			            if (!reconnectInterval) {
			                reconnectInterval = setInterval(() => {
			                    console.log("üîÑ Intentando reconectar WebSocket de mantenimiento...");
			                    connectMaintenance();
			                }, 5000); // cada 5 segundos
			            }
			        } else {
			            console.warn("üö´ Sin conexi√≥n a internet. Esperando a que vuelva...");
			        }
			    };
			}

			// --- CONTROL DE MANTENIMIENTO ---

			function controlarMantenimiento() {
			    const ahora = Date.now();
			    const ultimaEjecucion = parseInt(localStorage.getItem("ultimo_mantenimiento"), 10);
			    const intervalo = 30 * 60 * 1000; // 30 minutos

			    if (isNaN(ultimaEjecucion) || (ahora - ultimaEjecucion >= intervalo)) {
			        enviarMantenimiento();
			    } else {
			        const restante = intervalo - (ahora - ultimaEjecucion);
			        console.log(`‚è≥ Esperando ${Math.round(restante / 1000)} segundos para el siguiente mantenimiento`);
			        setTimeout(() => {
			            enviarMantenimiento();
			        }, restante);
			    }
			}

			function enviarMantenimiento() {
			    if (navigator.onLine && maintenance && maintenance.readyState === WebSocket.OPEN) {
			        maintenance.send(JSON.stringify({ action: "maintenance" }));
			        localStorage.setItem("ultimo_mantenimiento", Date.now());
			        console.log("‚úÖ Mantenimiento enviado");

			        setTimeout(() => {
			            enviarMantenimiento();
			        }, 30 * 60 * 1000);
			    } else {
			        console.warn("‚ùå No se pudo enviar mantenimiento (WebSocket cerrado o sin internet)");
			    }
			}

			// --- MANTENER CONEXI√ìN ACTIVA ---

			setInterval(() => {
			    if (navigator.onLine && maintenance && maintenance.readyState === WebSocket.OPEN) {
			        maintenance.send(JSON.stringify({ action: "ping" }));
			    }
			}, 10000); // cada 10 segundos

			// Iniciar conexi√≥n
			connectMaintenance();



			$(".generate_closure_report_by_date").click(function(){
				$("#generate_closure_report_by_date").modal('show')
			})

			$("#Generate_Closure_Report_By_Date").click(function () {
				let branch_id = $("#selectBranchs").val();
				let employee_id = $("#selectEmployee").val();
				let start_date = $("#start_dates").val();
				let end_date = $("#end_dates").val();

				if (!branch_id) {
					Swal.fire({
						icon: 'warning',
						title: 'Sucursal requerida',
						text: 'Por favor, seleccione una sucursal antes de continuar.',
						confirmButtonText: 'OK'
					});
					return;
				}

				let data = {
					branch_id: branch_id,
					employee_id: employee_id || null,
					start_date: start_date || null,
					end_date: end_date || null
				};

				// Mensaje de advertencia si no hay fechas o empleado seleccionado
				if (!employee_id || !start_date || !end_date) {
					let mensaje = "Est√° realizando la consulta solo por sucursal.";
					if (!employee_id && (start_date && end_date)) {
						mensaje = "Est√° realizando la consulta sin seleccionar un empleado.";
					}
					if ((employee_id && (!start_date || !end_date))) {
						mensaje = "Est√° realizando la consulta sin definir fechas.";
					}
					if (!employee_id && (!start_date || !end_date)) {
						mensaje = "Est√° realizando la consulta solo por sucursal, sin empleado ni fechas.";
					}

					Swal.fire({
						icon: 'question',
						title: '¬øDesea continuar?',
						text: mensaje,
						showCancelButton: true,
						confirmButtonText: 'S√≠, continuar',
						cancelButtonText: 'Cancelar'
					}).then((result) => {
						if (result.isConfirmed) {
							solicitarReporte(data);
						}
					});
				} else {
					solicitarReporte(data);
				}

				function solicitarReporte(data) {
					$(".message_modal").text("Cargando informaci√≥n...")
					showPreloaderModal();
					$.ajax({
						url: '{% url "Generate_Closure_Report_By_Date" %}',
						method: "POST",
						data: JSON.stringify(data),
						contentType: 'application/json',
						headers: {
							"X-CSRFToken": "{{ csrf_token }}"
						},
						success: function (response) {
							
							console.log("Respuesta:", response);
							$("#generate_closure_report_by_date").modal('hide');

							// Abrir el reporte en ventana centrada
							let screenWidth = window.screen.width;
							let screenHeight = window.screen.height;
							let windowWidth = 800;
							let windowHeight = 600;
							let leftPosition = (screenWidth - windowWidth) / 2;
							let topPosition = (screenHeight - windowHeight) / 2;

							let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=${windowWidth},height=${windowHeight},left=${leftPosition},top=${topPosition}`;
							window.open("{{request.session.url_interfaz}}/invoice/Generate_Closure_Report_By_Dates/", "Cierre de Caja", params);
							setTimeout(() => {
								hidePreloaderModal();
							}, 500);
						},
						error: function (xhr, status, error) {
							hidePreloaderModal();
							console.error("Error:", error);
							modalLoader.hide();
							Swal.fire({
								icon: 'error',
								title: 'Error',
								text: 'Ocurri√≥ un error al solicitar el reporte.',
								confirmButtonText: 'OK'
							});
						}
					});
				}
			});



			$(".history_mov").click(function(){
				$("#modalHistoryMovement").modal("show");
			})

			$("#historymovement").click(function() {
				let branch_id = $("#selectBranch").val();
				let start_date = $("#start_date").val();
				let end_date = $("#end_date").val();

				if (branch_id !== "") {
					$(".text_send_email").text('Espere mientras preparamos el documento.');
					var modalLoader = new bootstrap.Modal(document.getElementById('loader1'), {
						keyboard: false,
						backdrop: 'static'
					});
					modalLoader.show();

					const data = {
						branch_id: branch_id,
						start_date: start_date || null,
						end_date: end_date || null
					};

					$("#modalHistoryMovement").modal("hide");

					$.ajax({
						url: '{% url "Generate_Movement_History_Report" %}',
						method: "POST", 
						data: JSON.stringify(data),
						contentType: 'application/json',
						headers: {
							"X-CSRFToken": "{{ csrf_token }}"
						},
						success: function(response) {
							console.log("Respuesta:", response);
							modalLoader.hide();
							if (response.result) {
								const link = document.createElement("a");
								link.href = response.path_report;
								link.download = "movimientos_inventario.xlsx";
								document.body.appendChild(link);
								link.click();
								document.body.removeChild(link);
							} else {
								modalLoader.hide();
								Swal.fire({
									icon: 'warning',
									title: 'Atenci√≥n',
									text: response.message,
									confirmButtonText: 'OK'
								}).then((result) => {
									if (result.isConfirmed) {
										location.reload(true);
									}
								});
							}
						},
						error: function(xhr, status, error) {
							console.error("Error:", error);
							modalLoader.hide();
							Swal.fire({
								icon: 'error',
								title: 'Error',
								text: 'Ocurri√≥ un error al solicitar la informaci√≥n.',
								confirmButtonText: 'OK'
							}).then((result) => {
								if (result.isConfirmed) {
									location.reload(true);
								}
							});
							
						}
					});
				} else {
					Swal.fire({
						icon: 'error',
						title: 'Error',
						text: 'Debe seleccionar una sucursal.',
						confirmButtonText: 'OK'
					});
				}
			});


			// $("#modalResolution").modal("hide");




			$(".Get_Profit_Report_Excel").click(function(){
				console.log("Ejecutando")
				$(".text_send_email").text('Espere mientras preparamos el documento.');
				var modalLoader = new bootstrap.Modal(document.getElementById('loader1'), {
				  keyboard: false,
				  backdrop: 'static'
				});
				modalLoader.show();
				$.ajax({
					url : "{% url 'Get_Profit_Report' %}",
					success: function(response){
						console.log(response)
						if (response.path_report) {
							const link = document.createElement("a");
							link.href = response.path_report;
							link.download = "ventas_reporte.xlsx"; // Nombre opcional
							document.body.appendChild(link);
							link.click();
							document.body.removeChild(link);
						} else {
							alert("No se pudo generar el reporte.");
						}
						modalLoader.hide()
					}
				})
			})


			$(".export_sales_report").click(function(){
				$(".export_sales_report_modal").click()
			})

			$(".export_data").click(function(){
				data = {
				    "branch_id": {{request.session.branch_id|safe}},
				    "start_date":$("#fecha-inicial").val(),
				    "end_date":$("#fecha-final").val()
				}
				console.log(data)
				$.ajax({
					url : "{% url 'Export_Sales_Report' %}",
					data:data,
					success: function(response){
						console.log(response)
						if (response.path_report) {
							const link = document.createElement("a");
							link.href = response.path_report;
							link.download = "ventas_reporte.xlsx"; // Nombre opcional
							document.body.appendChild(link);
							link.click();
							document.body.removeChild(link);
							$(".close_export_data").click()
						} else {
							alert("No se pudo generar el reporte.");
						}
					}
				})
			})


			$(".generate_journal_report").click(function(){
				$(".generate_journal_report_modal").click()
			})

			$(".generate_journal_report_data").click(function(){
				$.ajax({
					url : "{% url 'Generate_Journal_Report' %}",
					data:{
					    "branch_id": {{request.session.branch_id|safe}},
					    "start_date":$("#fecha-inicial_journal").val(),
					    "state": "confirmado",
					    "end_date":$("#fecha-final_journal").val()
					},
					success: function(response){
						console.log(response)
						if (response.path_report) {
							const link = document.createElement("a");
							link.href = response.path_report;
							link.download = "ventas_reporte.xlsx"; // Nombre opcional
							document.body.appendChild(link);
							link.click();
							document.body.removeChild(link);
							$(".close_generate_journal_report_data").click()
						} else {
							alert("No se pudo generar el reporte.");
						}
					}
				})
			})



			$(".close_box").click(function () {
				$.ajax({
					url: "{% url 'Close_Box_Days' %}",
					success: function(response){
						console.log(response)
						if(response.result){
							if(response.print_close_box){
								abrirVentanaImpresion()
							}
							else{
								 window.location.href = "{% url 'Logins' %}";
							}
						}
						else{
							 Swal.fire({
								icon: 'error',
								title: 'Error',
								text: 'Ocurri√≥ un error al cerrar la caja.',
								confirmButtonText: 'OK'
							}).then((result) => {
								if (result.isConfirmed) {
									location.reload(true);
								}
							});
						}
					}
				})
			})

			$(".export_invoices_to_excel").click(function(){
				$("#modal_export_invoices_to_excel").modal('show')
			})

			$("#export_invoices_to_excel").click(function(){
			    let data = {
			        "branches": {{request.session.branch_list|safe}},
			        "date_from": $("#start_date__export_invoices_to_excel_from").val(),
			        "date_to": $("#end_date__export_invoices_to_excel_to").val()
			    };
			    $("#modal_export_invoices_to_excel").modal('hide')

			    $(".text_send_email").text('Espere mientras preparamos el documento.');
			    let modalLoader = new bootstrap.Modal(document.getElementById('loader1'), {
			      keyboard: false,
			      backdrop: 'static'
			    });
			    modalLoader.show();
			    $.ajax({
			        url: "{% url 'Export_Invoices_To_Excel' %}",
			        type: "POST",
			        data: JSON.stringify(data),
			        contentType: "application/json",
			        headers: {
			            "X-Requested-With": "XMLHttpRequest",
			            "X-CSRFToken": "{{ csrf_token }}"
			        },
			        success: function(response){
			        	modalLoader.hide();
			            console.log(response);
			            if (response.data && response.data.path_report) {
			                const link = document.createElement("a");
			                link.href = response.data.path_report;
			                link.download = "invoices_report.xlsx"; // Nombre opcional
			                document.body.appendChild(link);
			                link.click();
			                document.body.removeChild(link);
			            } else {
			                alert("No se pudo generar el reporte.");
			            }
			            
			        },
			        error: function(xhr){
			            console.error(xhr.responseText);
			            alert("Error generando el reporte.");
			            modalLoader.hide();
			        }
			    });
			});

			function abrirVentanaImpresion() {
			    let screenWidth = window.screen.width;
			    let screenHeight = window.screen.height;
			    let windowWidth = 800;
			    let windowHeight = 600;
			    let leftPosition = (screenWidth - windowWidth) / 2;
			    let topPosition = (screenHeight - windowHeight) / 2;

			    let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=${windowWidth},height=${windowHeight},left=${leftPosition},top=${topPosition}`;

			    let printWindow = window.open("{{request.session.url_interfaz}}/invoice/Generate_Closure_Report/", "Cierre de Caja", params);

			    let checkClosed = setInterval(function () {
			        if (printWindow.closed) {
			            clearInterval(checkClosed);
			            location.href = "{% url 'Logins' %}";
			        }
			    }, 500);

			    printWindow.onload = function () {
			        printWindow.document.body.style.zoom = "100%";
			        printWindow.print();
			        printWindow.onafterprint = function () {
			            printWindow.close();
			        };
			    };
			}


			
			$(document).on('keydown', function(event) {
			    if (event.key === 'F2') {
			        event.preventDefault();
			        location.href = "{% url 'Create_Invoice' 1 %}"		        
			    }
			    if (event.key === 'F3') {
			        event.preventDefault();
			        location.href = "{% url 'List_Invoice' 1 %}"
			    }

			    // // NEW COMMAND
			    else if (event.altKey && event.key === 'F1') {
			    	// Create invoice
			        event.preventDefault();
			        location.href = "{% url 'Crete_Quote' 27 %}"
			    }
			    else if (event.altKey && event.key === 'F2') {
			    	// Create quotes
			        event.preventDefault();
			        location.href = "{% url 'Create_Invoice' 1 %}"	
			    }
			    else if (event.altKey && event.key === 'F3') {
			    	// Create quotes
			        event.preventDefault();
			        location.href = "{% url 'Create_Transfer' 28 %}"	
			    }
			    else if (event.altKey && event.key === '1') {
			    	// List of invoices
			        event.preventDefault();
			        location.href = "{% url 'List_Invoice' 27 %}"
			    }
			    else if (event.altKey && event.key === '2') {
			    	//List of quotes
			        event.preventDefault();
			        location.href = "{% url 'List_Invoice' 1 %}"
			    }
			    else if (event.altKey && event.key === '3') {
			    	//List of quotes
			        event.preventDefault();
			        location.href = "{% url 'List_Invoice' 28 %}"
			    }

			    // END NEW COMMAND


			    if (disableRefresh) {
			        if (
			            event.key === "F5" || event.keyCode === 116 ||   // F5
			            (event.ctrlKey && (event.key.toLowerCase() === "r" || event.keyCode === 82)) // Ctrl+R
			        ) {
			            event.preventDefault();

			            Swal.fire({
			                toast: true,
			                position: 'top-end',
			                icon: 'warning',
			                title: "üö´ Refresh bloqueado",
			                text: "No puedes refrescar la p√°gina porque no hay internet.",
			                showConfirmButton: false,
			                timer: 4000,
			                timerProgressBar: true
			            });

			            return false;
			        }
			    }
			});


			// // Prevenir recarga/cierre de pesta√±a
			// $(window).on("beforeunload", function (event) {
			//     if (disableRefresh) {
			//         event.preventDefault();
			//         return "No puedes refrescar ni cerrar, se perder√≠an datos.";
			//     }
			// });


			$(".sales_by_product").click(function(){
				console.log("Hola")
				$("#sales_by_product_modal").modal('show')
			})

			$("#Generate_Closure_Sales_By_Product").click(function(){
				data = {
					branch_id : $("#selectBranchs_sales_by_product").val(),
					date_str : $("#start_dates_sales_by_product").val() || null,
					date_end : $("#end_dates_sales_by_product").val() || null,
				}
				$.ajax({
					url : "{% url 'Sales_By_Product' %}",
					method: "POST", 
					data: JSON.stringify(data),
					contentType: 'application/json',
					headers: {
						"X-CSRFToken": "{{ csrf_token }}"
					},
					success: function(response){
						console.log(response)
						$("#sales_by_product_modal").modal('hide')
						if (response.path_report) {
							const link = document.createElement("a");
							link.href = response.path_report;
							link.download = "sales_by_product.xlsx"; // Nombre opcional
							document.body.appendChild(link);
							link.click();
							document.body.removeChild(link);
						} else {
							Swal.fire({
								icon: 'error',
								title: 'Error',
								text: "No se pudo generar el reporte.",
								confirmButtonText: 'OK'
							})
						}
					}
				})
			})

			$(document).on("click", '.btn-accept', function(){
			    let btn = $(this); // Guardamos el bot√≥n para manipular el DOM
			    let notification_id = btn.data('id');
			    let employee_who_accepts = {{request.session.pk_employee|safe}};

			    let data = {
			        "notification_id": notification_id,
			        "employee_who_accepts": employee_who_accepts
			    };
			    console.log(data,'Data btn-accept');

			    $.ajax({
			        url: "{% url 'Transfer_Accepted' %}",
			        method: "POST",
			        contentType: 'application/json',
			        headers: {
			            "X-CSRFToken": "{{ csrf_token }}"
			        },
			        data: JSON.stringify(data),
			        success: function(response) {
			            console.log(response);
			            if(response.result){
			                // Remover la notificaci√≥n del DOM
			                btn.closest('li').remove();

			                // Actualizar contador de notificaciones
			                let badge = $("#notification-badge");
			                let totalUnread = parseInt(badge.text()) || 0;
			                totalUnread = totalUnread - 1;
			                badge.text(totalUnread > 9 ? "+9" : totalUnread);

			                // Si no quedan notificaciones, desactivar dropdown
			                if(totalUnread <= 0){
			                    $("#notification-toggle").off("click");
			                    $("#notification-dropdown").removeClass("show");
			                }

			                Swal.fire({
								icon: 'success',
								title: 'Proceso Finalizado',
								text: response.message,
								confirmButtonText: 'OK'
							})
			            } else {

			            	Swal.fire({
								icon: 'error',
								title: 'Error',
								text: "No se pudo aceptar la notificaci√≥n: " + response.message,
								confirmButtonText: 'OK'
							})
			            }
			        },
			        error: function(err){
			            console.error("Error al aceptar la notificaci√≥n:", err);
			        }
			    });
			});


			function loadNotifications() {
			    $.ajax({
			        url: "{% url 'Get_List_Notifications' %}",
			        method: "POST",
			        contentType: 'application/json',
			        headers: {
			            "X-CSRFToken": "{{ csrf_token }}"
			        },
			        success: function(response) {
			            console.log(response)
			            let totalUnread = response.total_unread || 0;
			            let badgeText = totalUnread > 9 ? "+9" : totalUnread;
			            $("#notification-badge").text(badgeText);

			            let list = $("#notification-list");
			            list.empty();

			            if(response.notifications.length > 0){
			                // Activar dropdown solo si hay notificaciones
			                $("#notification-toggle").off("click").on("click", function(){
			                    $("#notification-dropdown").toggleClass("show");
			                });

			                // Agregar notificaciones
			                response.notifications.forEach(function(item){
			                    console.log(item)
			                    list.append(`
			                        <li class="mb-2 p-2 border rounded bg-light">
			                            <h6 class="mb-1">${item.title}</h6>
			                            <p class="mb-2 small text-muted">${item.message}</p>
			                            <button class="btn btn-success btn-sm btn-block btn-accept" data-id="${item.id}">Aceptar</button>
			                        </li>
			                    `);
			                });

			                $("#notification-dropdown").append(`
			                    <div class="dropdown-footer p-2 text-center border-top">
			                        <a href="{% url 'List_Invoice' 28 %}" class="btn btn-primary btn-sm btn-block">
			                            Listado de Traslados
			                        </a>
			                    </div>
			                `);
			            }
			        },
			        error: function(err){
			            console.error("Error cargando notificaciones:", err);
			        }
			    });
			}



			loadNotifications();




		})
	</script>
	{% block script %}{% endblock %}
	<script src="{% static 'evangeli/commands.js' %}"></script>
	<script src="{% static 'evangeli/ai.js' %}"></script>
	<script src="{% static 'evangeli/evangeli.js' %}"></script>
	<script src="{% static 'evangeli/voices.js' %}"></script>
	
	
</body>
</body>
</html>