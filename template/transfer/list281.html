{% extends 'base.html' %}
{% load format_filters %}
{% block content %}
<style>
	.dataTables_paginate {
	    overflow-x: auto;
	    white-space: nowrap;
	    display: flex;
	    justify-content: center;
	}

	.dataTables_paginate .pagination {
	    flex-wrap: nowrap;
	}

	@media screen and (max-width: 400px) {
	    .dataTables_paginate {
	        font-size: 12px;
	    }
	}
</style>
<div class="row mb-2">
	<div class="col-md-6 col-sm-12">
		<div class="title">
			<h4>Listado de Translados Enviados (SALIDAS)</h4>
		</div>
	</div>
	<div class="col-md-6 col-sm-12 text-right">
		{% if request.session.rols == 'Todos' %}
			<select id="selectBranch" class="custom-select col-md-3 col-12 mb-2 select_branch">
				<option value="0" selected disabled>Elija Sucursal</option>
				{% for i in list_branch %}
					<option value="{{ i.id }}"{% if i.id == request.session.branch_id %} selected{% endif %}>
						{{ i.business_name }}
					</option>
				{% endfor %}
			</select>
		{% endif %}
	</div>
</div>

<div class="card-box mb-30 p-2">
	<div class="pb-20">
		<div class="table-responsive">
			<table class="data-table table table-stripe hover nowrap" style="width:100%">
		        <thead>
		            <tr>
		                <th class="table-plus datatable-nosort">Traslado</th>
		                <th>Sucursal</th>
		                <th>Fecha</th>
		                <th>Total</th>
		                <th>Estado</th>
		                <th>Acciones</th>
		            </tr>
		        </thead>
		        <tbody></tbody>
		    </table>
		</div>
	</div>
</div>



<!-- MODAL -->
<div class="modal fade" id="transfer_modal" tabindex="-1" role="dialog" aria-labelledby="transfer_modal_label" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title text-white" id="transfer_modal_label">Anular Traslado</h5>
        <button type="button" class="close text-white cerrar" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div class="text-center">
          <h5 class="mb-3">驴Est谩 seguro de que desea anular esta traslado?</h5>
          <p class="text-muted mb-4">
            Esta acci贸n no se puede deshacer y revertir谩 los movimientos de inventario asociados.
          </p>
        </div>

        <!-- Campo para la nota -->
        <div class="form-group text-left">
          <label for="transfer_note" class="font-weight-bold">Nota o motivo de anulaci贸n:</label>
          <textarea class="form-control" id="transfer_note" rows="3" placeholder="Escriba aqu铆 el motivo de la anulaci贸n..."></textarea>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary cerrar" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-danger" id="btn_anul_transfer">
          <i class="fas fa-check"></i> Anular Translado
        </button>
      </div>

    </div>
  </div>
</div>







{% endblock %}

{% block script %}
<script>
	
	let print_invoice = "{{ request.session.url_app }}/transfer/Print_Transfer/";
	let print_transfer = "{{ request.session.url_app }}/transfer/Print_Transfer/";
	let quoteId = null
	let information = new Object()
	let action = null
	let transfer_id = null
	let branch_id = {{request.session.branch_id|safe}}
	const acceptedCreditForms = [30, 45, 48]; // Formas de pago que requieren fecha

	function acortarURL(urlLarga) {
	    return $.ajax({
	        url: "https://api.tinyurl.com/create",
	        type: "POST",
	        headers: {
	            "Authorization": "Bearer PHWcrSo8wUcdwATg3Y2fJncm8WilJYVrd8JyQwf6maCGuMPgngPGNhlUyJC6",
	            "Content-Type": "application/json"
	        },
	        data: JSON.stringify({
	            url: urlLarga,
	            domain: "tiny.one"
	        })
	    });
	}

	$(document).ready(function () {

		$("#btn_anul_transfer").click(function () {
		    let data = {
		        "transfer_id": transfer_id,
		        "notes": $("#transfer_note").val()
		    };
		    
		    console.log(data);

		    $.ajax({
		        url: '{% url "Anulled_Transfer" %}',
		        method: 'POST',
		        data: JSON.stringify(data),
		        contentType: "application/json",
		        headers: {
		            "X-CSRFToken": "{{ csrf_token }}"
		        },
		        success: function (response) {
		            alert(response.message);
		            if (response.result) {
		                $('#transfer_modal').modal('hide');
		                // Aqu铆 puedes refrescar la tabla o recargar p谩gina
		                // location.reload();
		            }
		        },
		        error: function (xhr, status, error) {
		            console.error("Error:", error);
		            alert("Ocurri贸 un error al intentar anular la transferencia.");
		        }
		    });
		});


		$(".cerrar").click(function() {
			$("#transfer_modal").modal("hide")
		})

		$(document).on("click",'.anulled_transfer', function() {
			transfer_id = this.id
			console.log(transfer_id)
			$("#transfer_modal").modal("show")

		})

		function formatearMiles(valor) {
	        // Elimina todo excepto n煤meros
	        valor = valor.replace(/\D/g, '');
	        // Agrega puntos como separadores de miles
	        return valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
	    }

		$(document).on("input", ".monto", function () {
	      const input = $(this);
	      const caretPos = this.selectionStart;
	      let limpio = input.val().replace(/\./g, '');
	      if (!limpio) return;
	      let formateado = formatearMiles(limpio);

	      // Establece el valor formateado
	      input.val(formateado);

	      // Ajusta el cursor al final
	      this.setSelectionRange(formateado.length, formateado.length);
	  });

	  if ($.fn.DataTable.isDataTable('.table')) {
	      $('.table').DataTable().destroy();
	  }

	  $(document).on("click", ".copy_invoice", function(){
	  	let number = this.id
	  	console.log(number)
	  	let type_document = {{request.session.type_document|safe}}
	  	let screenWidth = window.screen.width;
	        let screenHeight = window.screen.height;
	        let windowWidth = 800;
	        let windowHeight = 600;
	        let leftPosition = (screenWidth - windowWidth) / 2;
	        let topPosition = (screenHeight - windowHeight) / 2;
	        let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=${windowWidth},height=${windowHeight},left=${leftPosition},top=${topPosition}`;
	        let printWindow = window.open(print_transfer + number + "/"+type_document, "invoice", params);
	        if (printWindow) {
		    printWindow.onload = function() {
		        printWindow.document.body.style.zoom = "100%";
		        setTimeout(() => {
			        printWindow.print();
			    }, 500);

		        printWindow.onafterprint = function() {
		            printWindow.close();
		        };
		    };

		    let checkClose = setInterval(function() {
		        if (printWindow.closed) {
		            clearInterval(checkClose);
		            console.log("La ventana de impresi贸n se ha cerrado");
		        }
		    }, 500);
		}
	  })
	  

	  // Abrir modal
	  $(document).on("click", ".bill", function () {
	      quoteId = parseInt(this.id, 10) || null;
	      $("#bill_quote_modal").modal("show");
	  });

	  // Funci贸n para calcular d铆as entre fechas
	  function getDaysBetweenDates(startDate, endDate) {
	      const start = new Date(startDate);
	      const end = new Date(endDate);
	      if (isNaN(start) || isNaN(end)) return 0;
	      const diff = end - start;
	      return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
	  }

	  function limpiarNumero(str) {
	    // "13.800,00" -> 13800.00
	    return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
		}

		function getCookie(name) {
		    let cookieValue = null;
		    if (document.cookie && document.cookie !== '') {
		        const cookies = document.cookie.split(';');
		        for (let i = 0; i < cookies.length; i++) {
		            const cookie = cookies[i].trim();
		            // 驴Esta cookie empieza con el nombre que buscamos?
		            if (cookie.substring(0, name.length + 1) === (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}

	    // Guardar informaci贸n
	  $("#bill_quote_save").click(function () {
		    const paymentForm = parseInt($("#selectPaymentForm").val(), 10);
		    const today = new Date().toISOString().split("T")[0];
		    const paymentDueDate = $("#payment_due_date").val();
		    const charge_indicator = $("#charge_indicator").val();
		    let amount_charges = $("#amount_charges").val();
		    const type_document = parseInt($("#type_invoice").val());

		    if (!paymentForm) {
		        alert("Debe seleccionar una forma de pago.");
		        return;
		    }

		    const isCredit = acceptedCreditForms.includes(paymentForm);

		    let information = {
		        quote_id: quoteId,
		        type_document: type_document,
		        paymentForm: {
		            payment_form_id: isCredit ? 2 : 1,
		            payment_method_id: paymentForm,
		            payment_due_date: isCredit && paymentDueDate ? paymentDueDate : today,
		            duration_measure: isCredit && paymentDueDate
		                ? getDaysBetweenDates(today, paymentDueDate)
		                : 0
		        }
		    };

		    if (charge_indicator !== "") {
		        information["other_charges"] = [
		            {
		                amount: limpiarNumero(amount_charges),
		                note: $("#allowance_charge_reason").val(),
		                charge_indicator: charge_indicator
		            }
		        ];
		    }

		    console.log("Informaci贸n lista para enviar:", information);

		    // Enviar al backend en JSON
		    $.ajax({
		        url: "{% url 'Bill_Quote' %}",
		        type: "POST",
		        contentType: "application/json",
		        headers: { "X-CSRFToken": getCookie("csrftoken")},
		        data: JSON.stringify(information),
		        success: function (response) {
		            console.log("Respuesta del servidor:", response);
		            if(response.data.result){
	            		Swal.fire({
					      icon: 'success',
					      title: "Tarea Finalizada",
					      text: response.data.quote.message,
					      confirmButtonText: 'OK',
					      confirmButtonColor: '#3085d6'
					    }).then((result) => {
					    	let number = response.data.quote.invoice_id
					    	console.log(number)
					    	let type_document = {{request.session.type_document|safe}}
					    	let screenWidth = window.screen.width;
				            let screenHeight = window.screen.height;
				            let windowWidth = 800;
				            let windowHeight = 600;
				            let leftPosition = (screenWidth - windowWidth) / 2;
				            let topPosition = (screenHeight - windowHeight) / 2;
				            let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=${windowWidth},height=${windowHeight},left=${leftPosition},top=${topPosition}`;
				            let printWindow = window.open(print_invoice + number + "/"+type_document, "invoice", params);
				            if (printWindow) {
							    printWindow.onload = function() {
							        printWindow.document.body.style.zoom = "100%";
							        setTimeout(() => {
								        printWindow.print();
								    }, 500);

							        printWindow.onafterprint = function() {
							            printWindow.close();
							        };
							    };

							    let checkClose = setInterval(function() {
							        if (printWindow.closed) {
							            clearInterval(checkClose);
							            console.log("La ventana de impresi贸n se ha cerrado");
							        }
							    }, 500);
							}
					      if (result.isConfirmed) {
					        location.reload(true)
					      }
					    })
					}
					else{
						Swal.fire({
						  icon: 'error',
						  title: "Oopss.. Algo sali贸 mal.",
						  text: response.data.message,
						  confirmButtonText: 'OK',
						  confirmButtonColor: '#3085d6'
						})
					}
		           
		        },
		        error: function (xhr) {
		            console.error("Error:", xhr.responseText);
		        }
		    });
		});


	    // Mostrar/ocultar campo de fecha seg煤n forma de pago
	    $("#selectPaymentForm").change(function () {
	        const paymentForm = parseInt($(this).val(), 10);
	        if (acceptedCreditForms.includes(paymentForm)) {
	            $(".payment_due_date").removeAttr("hidden");
	        } else {
	            $(".payment_due_date").attr("hidden", true);
	            $("#payment_due_date").val(""); // limpiar fecha
	        }
	    });

	    const table = $('.table').DataTable({
		    responsive: true,
		    serverSide: true,
		    processing: true,
		    searching: true,
		    pagingType: "simple_numbers",
		    ajax: {
		        url: "{% url 'Get_List_Transfer' %}",
		        type: "GET",
		        headers: { "X-Requested-With": "XMLHttpRequest" },
		        data: function (d) {
		            d.branch_id = branch_id;
		            d.input = false;
		            d.search = d.search || {};
		            d.search.value = d.search.value || '';
		        },
		        dataSrc: function (json) {
		            return json.data || [];
		        }
		    },
		    columns: [
		        { data: "transfer", title: "Traslado", className: "table-plus" },
						{ data: "branch_receives__business_name", title: "Sucursal" },
		        { data: "date_only", title: "Fecha" },
		        {
		            data: "total",
		            title: "Total",
		            render: function (data, type, row) {
		                if (isNaN(data)) return data;
		                return '$ ' + new Intl.NumberFormat('es-CO', {
		                    minimumFractionDigits: 2,
		                    maximumFractionDigits: 2
		                }).format(data);
		            }
		        },
		        { data: "status", title: "Estado de la factura" },
		        {
					    data: null,
					    title: "Acciones",
					    render: function (data, type, row) {
					    	console.log(branch_id)
						    let branchIdSelected = parseInt($("#selectBranch").val());

						    // ID 煤nico para el bot贸n de WhatsApp
						    var whatsappId = "wa_link_" + row.id;

						    let actions = `
						        <div class="dropdown">
						            <a class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle" href="#" role="button" data-toggle="dropdown">
						                <i class="dw dw-more"></i>
						            </a>
						            <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
						                
						    `;
						    actions += `
						    	<a class="dropdown-item copy_invoice" data-pk="${row.id}" id="${row.id}" href="javascript:void(0);"><i class="dw dw-copy"></i> Copia</a>
						    `;
								if (!row.anulled) {
						        actions += `
						            <a class="dropdown-item anulled_transfer" data-pk="${row.id}" id="${row.id}" href="javascript:void(0);">
						                <i class="dw dw-delete-3"></i> Anular
						            </a>
						        `;
								}
						    actions += `
						            </div>
						        </div>
						    `;	

						    return actions;
						}


					}

		    ],
		    lengthMenu: [20, 30, 40, 50, 80, 100],
		    language: {
		        url: "https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json"
		    },
		    drawCallback: function () {
		        console.log(' Tabla actualizada con nueva data');
		    }
		});
		
		$(document).on('click', '.send_email_invoice', function () {
		    const id = this.id;
		    const type_document = {{ request.session.type_document|default:0 }};
		    const branch_id = {{ request.session.branch_id|default:0 }};

		    if (type_document != 99) {
		        const data = {
		            number: id,
		            branch_id: branch_id,
		            type_document: type_document
		        };

		        $.ajax({
		            url: "{% url 'Send_Email_Invoice' %}",
		            method: "POST",
		            headers: {
					    "X-Requested-With": "XMLHttpRequest",
					    "X-CSRFToken": "{{ csrf_token }}"
					},
		            data: data,
		            success: function (response) {
		                console.log(response);
						if (response.status === 'success') {
						    if (response.data.result) {
						        Swal.fire({
						            icon: 'success',
						            title: 'Correo enviado',
						            text: 'La factura ha sido enviada correctamente.'
						        });
						    } else {
						        Swal.fire({
						            icon: 'error',
						            title: 'Oops... Algo ha salido mal',
						            text: response.data.message || 'No se pudo enviar el correo.'
						        });
						    }
						} else {
						    Swal.fire({
						        icon: 'error',
						        title: 'Error',
						        text: response.error || 'Error desconocido al enviar el correo.'
						    });
						}

		            },
		            error: function (xhr, status, error) {
		                console.error("Error AJAX:", error);
		                Swal.fire({
		                    icon: 'error',
		                    title: 'Error de red',
		                    text: 'Hubo un problema al enviar la solicitud.'
		                });
		            }
		        });
		    }
		});


		$(document).on('click', '.anulled_invoice', function () {
		    const id = this.id;
		    const type_document = {{ request.session.type_document|default:0 }};
		    const branch_id = {{ request.session.branch_id|default:0 }};

		    const data = {
		        number: id,
		        branch_id: branch_id,
		        type_document: type_document
		    };

		    $.ajax({
		        url: "{% url 'Anulled_Invoice' %}",
		        method: "POST",
		        headers: {
		            "X-Requested-With": "XMLHttpRequest",
		            "X-CSRFToken": "{{ csrf_token }}"
		        },
		        data: data,
		        success: function (response) {
		            console.log(response,'response');

		            if (response.status === 'success') {
		                if (response.data.result) {
		                    Swal.fire({
		                        icon: 'success',
		                        title: 'Factura anulada',
		                        text: response.data.message
		                    });

		                    //  Recargar tabla para reflejar el nuevo estado
		                    table.ajax.reload(null, false); // false = no reiniciar paginaci贸n
		                } else {
		                    Swal.fire({
		                        icon: 'error',
		                        title: 'Error',
		                        text: response.error || 'No se pudo anular la factura.'
		                    });
		                }
		            } else {
		                Swal.fire({
		                    icon: 'error',
		                    title: 'Error',
		                    text: response.error || 'Error desconocido al anular la factura.'
		                });
		            }
		        },
		        error: function (xhr, status, error) {
		            console.error("Error AJAX:", error);
		            Swal.fire({
		                icon: 'error',
		                title: 'Error de red',
		                text: 'Hubo un problema al enviar la solicitud.'
		            });
		        }
		    });
		});

		$(document).on('click', '.view_pdf', function () {
			showPreloaderModal()
		    const id = this.id;
		    const type_document = {{ request.session.type_document|default:0 }};
		    const branch_id = {{ request.session.branch_id|default:0 }};

		    const data = {
		        number: id,
		        branch_id: branch_id,
		        type_document: type_document
		    };
		    console.log(data)

		    $.ajax({
		        url: "{% url 'Create_PDF' %}",
		        method: "POST",
		        headers: {
		            "X-Requested-With": "XMLHttpRequest",
		            "X-CSRFToken": "{{ csrf_token }}"
		        },
		        data: data,
		        success: function (response) {
		            console.log(response);
		            hidePreloaderModal()

		            if (response.data.result) {
		                window.open(response.data.url, '_blank');
		            } else {
		                Swal.fire({
		                    icon: 'error',
		                    title: 'Error',
		                    text: response.message || 'Error desconocido al crear el PDF.'
		                });
		            }
		        },
		        error: function (xhr, status, error) {
		            console.error("Error AJAX:", error);
		            Swal.fire({
		                icon: 'error',
		                title: 'Error de red',
		                text: 'Hubo un problema al enviar la solicitud.'
		            });
		        }
		    });
		});


	    $(".select_branch").change(function(){
	    	branch_id = $(this).val()
	    	table.ajax.reload();
	    })

	});
</script>
{% endblock %}
