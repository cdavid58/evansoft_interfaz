{% extends '../base.html' %}
{% load format_filters %}
{% block content %}
<style>
	.dataTables_paginate {
	    overflow-x: auto;
	    white-space: nowrap;
	    display: flex;
	    justify-content: center;
	}

	.dataTables_paginate .pagination {
	    flex-wrap: nowrap;
	}

	@media screen and (max-width: 400px) {
	    .dataTables_paginate {
	        font-size: 12px;
	    }
	}
</style>
<div class="row mb-3 align-items-center">
  <!-- T铆tulo -->
  <div class="col-md-6 col-sm-12 mb-2 mb-md-0">
    <h4 class="mb-0">Listado de Traslados</h4>
  </div>

  <!-- Select de tipo de traslado -->
  <div class="col-md-2 col-sm-6 mb-2 mb-md-0 ml-auto">
    <select id="selectBranchFrom" class="custom-select select_operation">
      <option value="1">ENVIA</option>
      <option value="2">RECIBE</option>
    </select>
  </div>

  <!-- Select de sucursal destino -->
  {% if request.session.rols == 'Todos' %}
  <div class="col-md-4 col-sm-6">
    <select id="selectBranchTo" class="custom-select select_branch">
      <option value="0" selected disabled>Elija Sucursal Destino</option>
      {% for i in list_branch %}
      <option value="{{ i.id }}"{% if i.id == request.session.branch_id %} selected{% endif %}>
        {{ i.business_name }}
      </option>
      {% endfor %}
    </select>
  </div>
  {% endif %}
</div>


<div class="card-box mb-30 p-2">
	<div class="pb-20">
		<div class="table-responsive">
			<table class="data-table table table-stripe hover nowrap" style="width:100%">
		        <thead>
		            <tr>
		                <th class="table-plus datatable-nosort">Traslado</th>
		                <th>Sucursal</th>
		                <th>Sucursal</th>
		                <th>Fecha</th>
		                <th>Total</th>
		                <th>Estado</th>
		            </tr>
		        </thead>
		        <tbody></tbody>
		    </table>
		</div>
	</div>
</div>



<!-- MODAL -->
<div class="modal fade" id="transfer_modal" tabindex="-1" role="dialog" aria-labelledby="transfer_modal_label" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title text-white" id="transfer_modal_label">Anular Transferencia</h5>
        <button type="button" class="close text-white cerrar" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div class="text-center">
          <h5 class="mb-3">驴Est谩 seguro de que desea anular esta transferencia?</h5>
          <p class="text-muted mb-4">
            Esta acci贸n no se puede deshacer y revertir谩 los movimientos de inventario asociados.
          </p>
        </div>

        <!-- Campo para la nota -->
        <div class="form-group text-left">
          <label for="transfer_note" class="font-weight-bold">Nota o motivo de anulaci贸n:</label>
          <textarea class="form-control" id="transfer_note" rows="3" placeholder="Escriba aqu铆 el motivo de la anulaci贸n..."></textarea>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary cerrar" data-dismiss="modal">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-danger" id="btn_anul_transfer">
          <i class="fas fa-check"></i> Anular Transferencia
        </button>
      </div>

    </div>
  </div>
</div>







{% endblock %}

{% block script %}
<script>
	
	let print_invoice = "{{ request.session.url_app }}/transfer/Print_Transfer/";
	let print_transfer = "{{ request.session.url_app }}/transfer/Print_Transfer/";
	let quoteId = null
	let information = new Object()
	let action = null
	let transfer_id = null
	let branch_id = {{request.session.branch_id|safe}}
	const acceptedCreditForms = [30, 45, 48]; // Formas de pago que requieren fecha

	function acortarURL(urlLarga) {
	    return $.ajax({
	        url: "https://api.tinyurl.com/create",
	        type: "POST",
	        headers: {
	            "Authorization": "Bearer PHWcrSo8wUcdwATg3Y2fJncm8WilJYVrd8JyQwf6maCGuMPgngPGNhlUyJC6",
	            "Content-Type": "application/json"
	        },
	        data: JSON.stringify({
	            url: urlLarga,
	            domain: "tiny.one"
	        })
	    });
	}

	$(document).ready(function () {

		let operation = parseInt($(".select_operation").val()) || 1;


		$("#btn_anul_transfer").click(function () {
		    let data = {
		        "transfer_id": transfer_id,
		        "notes": $("#transfer_note").val()
		    };
		    
		    console.log(data);

		    $.ajax({
		        url: '{% url "Anulled_Transfer" %}',
		        method: 'POST',
		        data: JSON.stringify(data),
		        contentType: "application/json",
		        headers: {
		            "X-CSRFToken": "{{ csrf_token }}"
		        },
		        success: function (response) {
		            if (response.result) {
	            		$('#transfer_modal').modal('hide');
	            		$("#transfer_note").val('')
	                Swal.fire({
							      icon: 'success',
							      title: 'Tarea Finalizada',
							      text: 'El traslado fue anulado / rechazado correctamente',
							      confirmButtonText: 'OK',
							      confirmButtonColor: '#3085d6',
							    }).then((result) => {
							      if (result.isConfirmed) {
							        location.reload(true)
							      }
							    });
		            }
		        },
		        error: function (xhr, status, error) {
		            Swal.fire({
						      icon: 'error',
						      title: 'Oop... Algo ha salido mal',
						      text: response.message,
						      confirmButtonText: 'OK',
						      confirmButtonColor: '#3085d6',
						    })
		        }
		    });
		});


		$(".cerrar").click(function() {
			$("#transfer_modal").modal("hide")
		})

		$(document).on("click",'.anulled_transfer', function() {
			transfer_id = this.id
			console.log(transfer_id)
			$("#transfer_modal").modal("show")

		})

		function formatearMiles(valor) {
        // Elimina todo excepto n煤meros
        valor = valor.replace(/\D/g, '');
        // Agrega puntos como separadores de miles
        return valor.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

		$(document).on("input", ".monto", function () {
        const input = $(this);
        const caretPos = this.selectionStart;

        // Limpia el valor
        let limpio = input.val().replace(/\./g, '');
        if (!limpio) return;

        // Formatea
        let formateado = formatearMiles(limpio);

        // Establece el valor formateado
        input.val(formateado);

        // Ajusta el cursor al final
        this.setSelectionRange(formateado.length, formateado.length);
    });

    if ($.fn.DataTable.isDataTable('.table')) {
        $('.table').DataTable().destroy();
    }

    $(document).on("click", ".copy_invoice", function(){
    	let number = this.id
    	console.log(number)
    	let type_document = {{request.session.type_document|safe}}
    	let screenWidth = window.screen.width;
          let screenHeight = window.screen.height;
          let windowWidth = 800;
          let windowHeight = 600;
          let leftPosition = (screenWidth - windowWidth) / 2;
          let topPosition = (screenHeight - windowHeight) / 2;
          let params = `scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=${windowWidth},height=${windowHeight},left=${leftPosition},top=${topPosition}`;
          let printWindow = window.open(print_transfer + number + "/"+type_document, "invoice", params);
          if (printWindow) {
		    printWindow.onload = function() {
		        printWindow.document.body.style.zoom = "100%";
		        setTimeout(() => {
			        printWindow.print();
			    }, 500);

		        printWindow.onafterprint = function() {
		            printWindow.close();
		        };
		    };

		    let checkClose = setInterval(function() {
		        if (printWindow.closed) {
		            clearInterval(checkClose);
		            console.log("La ventana de impresi贸n se ha cerrado");
		        }
		    }, 500);
		}
    })
    

    // Funci贸n para calcular d铆as entre fechas
    function getDaysBetweenDates(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        if (isNaN(start) || isNaN(end)) return 0;
        const diff = end - start;
        return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
    }

    function limpiarNumero(str) {
	    // "13.800,00" -> 13800.00
	    return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
		}

		function getCookie(name) {
		    let cookieValue = null;
		    if (document.cookie && document.cookie !== '') {
		        const cookies = document.cookie.split(';');
		        for (let i = 0; i < cookies.length; i++) {
		            const cookie = cookies[i].trim();
		            // 驴Esta cookie empieza con el nombre que buscamos?
		            if (cookie.substring(0, name.length + 1) === (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}


    // Mostrar/ocultar campo de fecha seg煤n forma de pago
    $("#selectPaymentForm").change(function () {
        const paymentForm = parseInt($(this).val(), 10);
        if (acceptedCreditForms.includes(paymentForm)) {
            $(".payment_due_date").removeAttr("hidden");
        } else {
            $(".payment_due_date").attr("hidden", true);
            $("#payment_due_date").val(""); // limpiar fecha
        }
    });


		//  Funci贸n para renderizar las acciones
		function renderAcciones(data, type, row) {
		    let branchIdSelected = parseInt($("#selectBranch").val());



		    let actions = `
		        <div class="dropdown">
		            <a class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle" href="#" role="button" data-toggle="dropdown">
		                <i class="dw dw-more"></i>
		            </a>
		            <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
		                <a class="dropdown-item copy_invoice" data-pk="${row.id}" id="${row.id}" href="javascript:void(0);">
		                    <i class="dw dw-copy"></i> Copia
		                </a>
		    `;
		    actions += `
		    	<a class="dropdown-item bill" id="${row.id}" data-pk="${row.id}" href="javascript:void(0);" ><i class="dw dw-file4"></i> Aceptar </a>
		    `;

		    if (!row.anulled) {
		        if (row.branch_delivery__id !== branchIdSelected) {
		            actions += `
		                <a class="dropdown-item anulled_transfer" data-pk="${row.id}" id="${row.id}" href="javascript:void(0);">
		                    <i class="dw dw-delete-3"></i> Rechazar
		                </a>
		            `;
		        } else {
		            actions += `
		                <a class="dropdown-item anulled_transfer" data-pk="${row.id}" id="${row.id}" href="javascript:void(0);">
		                    <i class="dw dw-delete-3"></i> Anular
		                </a>
		            `;
		        }
		    }

		    actions += `
		            </div>
		        </div>
		    `;
		    return actions;
		}

		//  Columnas para ENTRADAS (Recibidos)
		const columnsEntrada = [
		    { data: "transfer", title: "Traslado", className: "table-plus" },
		    { data: "branch_delivery__business_name", title: "Sucursal que Env铆a" },
		    { data: "date_only", title: "Fecha" },
		    {
		        data: "total",
		        title: "Total",
		        render: function (data) {
		            if (isNaN(data)) return data;
		            return '$ ' + new Intl.NumberFormat('es-CO', {
		                minimumFractionDigits: 2,
		                maximumFractionDigits: 2
		            }).format(data);
		        }
		    },
		    { data: "status", title: "Estado de la factura" },
		    { data: null, title: "Acciones", render: renderAcciones }
		];

		//  Columnas para SALIDAS (Enviados)
		const columnsSalida = [
		    { data: "transfer", title: "Traslado", className: "table-plus" },
		    { data: "branch_receives__business_name", title: "Sucursal que Recibe" },
		    { data: "date_only", title: "Fecha" },
		    {
		        data: "total",
		        title: "Total",
		        render: function (data) {
		            if (isNaN(data)) return data;
		            return '$ ' + new Intl.NumberFormat('es-CO', {
		                minimumFractionDigits: 2,
		                maximumFractionDigits: 2
		            }).format(data);
		        }
		    },
		    { data: "status", title: "Estado de la factura" },
		    { data: null, title: "Acciones", render: renderAcciones }
		];

		//  Funci贸n para inicializar la tabla seg煤n operaci贸n
		function initTable(operation) {
		    if ($.fn.DataTable.isDataTable('.table')) {
		        $('.table').DataTable().destroy();
		        $('.table').empty();
		    }

		    const columns = operation === 1 ? columnsEntrada : columnsSalida;

		    $('.table').DataTable({
		        responsive: true,
		        serverSide: true,
		        processing: true,
		        searching: true,
		        order: [[2, 'desc']],
		        pagingType: "simple_numbers",
		        ajax: {
		            url: "{% url 'Get_List_Transfer' %}",
		            type: "GET",
		            headers: { "X-Requested-With": "XMLHttpRequest" },
		            data: function (d) {
		                d.branch_id = branch_id;
		                d.operation = operation;
		                d.search = d.search || {};
		                d.search.value = d.search.value || '';
		            },
		            dataSrc: function (json) {
		                return json.data || [];
		            }
		        },
		        columns: columns,
		        lengthMenu: [20, 30, 40, 50, 80, 100],
		        language: {
		            url: "https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json"
		        },
		        drawCallback: function () {
		            console.log(` Tabla actualizada (${operation === 1 ? 'Recibidos' : 'Enviados'})`);
		        }
		    });
		}

		//  Inicializar tabla al cargar la p谩gina
		
		initTable(operation);

		//  Cambiar tabla cuando el usuario selecciona otra operaci贸n
		$(".select_operation").on("change", function () {
		    let op = parseInt($(this).val());
		    console.log("Operaci贸n seleccionada:", op === 1 ? "Recibidos" : "Enviados");
		    initTable(op);
		});

    $(".select_branch").change(function(){
    	branch_id = $(this).val()
    	// table.ajax.reload();
    	let op = parseInt($(".select_operation").val())
    	initTable(op);
    })

	  $(document).on("click", '.accept', function(){
	    let transfer_id = this.id;
	    let employee_who_accepts = {{request.session.pk_employee|safe}};

	    let data = {
	        "transfer_id": transfer_id,
	        "employee_who_accepts": employee_who_accepts
	    };
	    console.log(data,'Data btn-accept');

	    $.ajax({
	        url: "{% url 'Transfer_Accepted' %}",
	        method: "POST",
	        contentType: 'application/json',
	        headers: {
	            "X-CSRFToken": "{{ csrf_token }}"
	        },
	        data: JSON.stringify(data),
	        success: function(response) {
	            console.log(response);
	            if(response.result){
	                Swal.fire({
										icon: 'success',
										title: 'Proceso Finalizado',
										text: response.message,
										confirmButtonText: 'OK'
									}).then((result) => {
										if (result.isConfirmed) {
							      	location.reload(true)
							      }
									})
	            } else {

	            	Swal.fire({
						icon: 'error',
						title: 'Error',
						text: "No se pudo aceptar la notificaci贸n: " + response.message,
						confirmButtonText: 'OK'
					})
	            }
	        },
	        error: function(err){
	            console.error("Error al aceptar la notificaci贸n:", err);
	        }
	    });
		});

	});
</script>
{% endblock %}
